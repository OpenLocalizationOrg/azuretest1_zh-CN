---
ms.openlocfilehash: 118aad9b3ef8cac0903f019286fe6df73afa9899
ms.sourcegitcommit: bab1265d669c3e6871daa7cb8a5640a47104947a
translationtype: MT
---
<properties
   pageTitle="点到站点 VPN 连接到 Azure 虚拟网络配置 |Microsoft Azure"
   description="通过创建点到站点 VPN 连接牢固地连接到 Azure 虚拟网络。"
   services="vpn-gateway"
   documentationCenter="na"
   authors="cherylmc"
   manager="jdial"
   editor="tysonn"/>

<tags
   ms.service="vpn-gateway"
   ms.devlang="na"
   ms.topic="hero-article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="08/11/2015"
   ms.author="cherylmc"/>

# 配置点到站点 VPN 连接到 Azure 虚拟网络


>[AZURE.NOTE] 本文适用于为典型的部署模式中创建的虚拟网络的点到站点连接。 这次不支持点到站点连接到 Azure 资源管理器部署模式中创建虚拟网络。

下面的过程将引导您完成创建安全点到站点连接到虚拟网络的步骤。 虽然配置点到站点连接，需要多个步骤，就不需要购买和配置 VPN 设备已从您的计算机连接到虚拟网络安全的好方法。 有配置点到站点 VPN 的三个主要部分︰ 虚拟网络和 VPN 网关，用于身份验证和用于连接到虚拟网络的 VPN 客户端的证书。 配置每个顺序非常重要，所以不要跳过步骤或向前跳。


1. [创建虚拟网络和 VPN 网关](#create-a-virtual-network-and-a-vpn-gateway)。
2. [创建您的证书](#create-your-certificates)。
3. [配置您的 VPN 客户端](#configure-your-vpn-client)。

## 创建虚拟网络和 VPN 网关



点到站点连接要求使用动态路由的网关的虚拟网络。 以下步骤将引导您完成创建两者。

### 创建虚拟网络

1. 登录到**Azure 的门户**。
1. 在屏幕的左下角，单击**新建**。 在导航窗格中，单击**网络服务**，然后单击**虚拟网络**。 单击**创建自定义**启动配置向导。
1. 在**虚拟的网络详细信息**页上，输入以下信息，然后单击右下角上的下箭头。
    - **名称**︰ 命名您的虚拟网络。 例如"VNetEast"。 这将是到此 VNet 部署虚拟机和 PaaS 实例时将参考名称。
    - **位置**︰ 位置直接关系到希望资源 (Vm) 所在的物理位置 （区域）。 例如，如果您希望将 Vm 部署到物理上位于东亚美国此虚拟网络，选择该位置。 不能更改所创建与虚拟网络的地区。
1. 在**DNS 服务器和 VPN 连接**页面上，输入以下信息，然后单击右下方的下箭头。
    - **DNS 服务器**︰ 输入 DNS 服务器名称和 IP 地址，或从快捷菜单中选择先前已注册的 DNS 服务器。 此设置不会创建一个 DNS 服务器，它允许您指定要使用的虚拟网络名称解析的 DNS 服务器。 如果您想要使用 Azure 默认名称解析服务，则将此部分留空。
    - **配置点到站点 VPN**︰ 选中该复选框。
1. 在**点对站点的连接**页面上，指定您的 VPN 客户端将从中接收 IP 地址时连接的 IP 地址范围。 有一些规则可以指定的地址范围。 它是非常重要，若要验证您指定的范围不与任何位于内部网络上的范围重叠。
1. 输入以下信息，然后单击向下箭头。
 - **地址空间**︰ 包括起始 IP 和 CIDR （地址计数）。
 - **添加地址空间**︰ 仅当添加所需的网络设计。
1. 在**虚拟的网络地址空间**页上，指定要使用的虚拟网络地址范围。 这些都是动态的 IP 地址 (DIP) 将分配给虚拟机，该虚拟网络部署其他角色实例。 它是特别重要，要选择具有任何内部网络使用的范围不会重叠的范围。 您需要与您的网络管理员，他刻出内部网络地址空间供您使用的虚拟网络范围内的 IP 地址可能需要协调一致。
1. 输入以下信息，然后单击复选标记以开始创建虚拟网络。
 - **地址空间**︰ 添加您想要使用的虚拟网络，包括起始 IP 和计数的内部 IP 地址范围。 请务必选择与任何内部网络使用的范围不会重叠的范围。 您需要与您的网络管理员，他刻出内部网络地址空间供您使用的虚拟网络范围内的 IP 地址可能需要协调一致。
 - **添加子网**︰ 其他子网不是必需的但可能希望为将具有静态 DIP 的虚拟机创建一个单独的子网。 或者，您可能想要您的 Vm 中其他角色实例与不同的子网。
 - **添加网关网**︰ 网关网是需要点到站点 VPN。 单击此处添加网关网。 网关网仅用于虚拟网络网关。
1. 当创建虚拟网络后时，您将看到**创建**Azure 门户中的网络页上列出**状态**下。 一旦创建虚拟网络，您可以创建动态路由网关。

### 创建一个动态路由网关

1. 在 Azure 的门户中，在**网络**页面中，单击刚刚创建，并导航到**仪表板**页的虚拟网络。
1. 单击**创建网关**，位于**仪表板**页面的底部。 将显示一条消息，询问**您要创建虚拟网络"yournetwork"的网关**。 单击**是**以开始创建网关。 它可以需要大约 15 分钟来创建网关。

## 创建您的证书

证书用于验证 VPN 客户端的点到站点 Vpn。 此过程包括多个步骤。 使用下面的链接以完成每个步骤的顺序。

1. 仅[生成一个自签名的根证书](#generate-a-self-signed-root-certificate)的自签名的根证书支持这一次。
2. [上载到 Azure 的门户网站的根证书文件](#upload-the-root-certificate-file-to-the-management-portal)。
3. [生成客户端证书](#generate-a-client-certificate)。
4. [导出并安装客户端证书](#export-and-install-the-client-certificate)。

### 生成一个自签名的根证书

1. 创建 X.509 证书的一种方法是使用证书创建工具 (makecert.exe)。 若要使用 makecert，下载并安装[Microsoft Visual Studio 速成 2013 的 Windows 桌面](https://www.visualstudio.com/products/visual-studio-express-vs.aspx)，这是免费。
2. 导航到 Visual Studio 工具文件夹，并作为管理员启动命令提示符。
3. 在下面的示例命令将创建和安装在您计算机上的个人证书存储中的根证书并创建相应的*.cer*文件会稍后上载到 Azure 的门户。
4. 将更改为所需的.cer 文件中并运行以下命令，其中*RootCertificateName*是您想要使用的证书的名称的目录。 如果原封不动地运行以下示例时，结果将根证书和相应的文件*RootCertificateName.cer*。

>[AZURE.NOTE] 因为您已经将会生成客户端证书的根证书，您可以导出该证书及其私钥一起并将其保存到安全的位置，可能会恢复。

    makecert -sky exchange -r -n "CN=RootCertificateName" -pe -a sha1 -len 2048 -ss My "RootCertificateName.cer"

### 将根证书文件上载到 Azure 门户

1. 在早期的过程中生成一个自签名的根证书，也可以创建一个*.cer*文件。 现在将该文件上载到 Azure 的门户。 请注意，此.cer 文件不包含根证书的专用密钥。
1. 在 Azure 的门户中，虚拟网络，**证书**页上单击**上载根证书**。
1. 在**上载证书**页中，对于.cer 根证书，请浏览，然后单击复选标记。

### 生成客户端证书

1. 用于创建自签名的根证书的同一台计算机，在以管理员身份打开 Visual Studio 命令提示符窗口。
2. 将目录更改为您要在其中保存客户端证书文件的位置。 *RootCertificateName*是指您生成自签名的根证书。 如果运行下面的示例 （更改您的根证书的名称为 RootCertificateName），结果将是名为"ClientCertificateName"在您的个人证书存储区中的客户端证书。
3. 键入以下命令︰

    makecert.exe n"CN = ClientCertificateName"-pe-天空交换-m 96-ss 我-在"RootCertificateName"-是我的 sha1

4. 所有证书都存储在您计算机上的个人证书存储区中。 检查*certmgr*验证。 您可以生成为许多客户端证书需要基于此过程。 我们建议您在您想要连接到虚拟网络的每台计算机的证书创建唯一的客户机。

### 导出并安装客户端证书

1. 必须在您想要连接到虚拟网络的每台计算机上安装客户端证书。 这意味着将可能需要创建多个客户端证书，则需要将其导出。 若要导出客户端证书，请使用*certmgr.msc*。 右键单击您要导出，单击**所有任务**，然后单击**导出**客户端证书。
2. 导出带私钥的*客户端证书*。 这将是一个*.pfx*文件。 请确保记录或记住此证书设置密码 （密钥）。
3. 将*.pfx*文件复制到客户端计算机。 在客户端计算机上，安装双击*.pfx*文件。 输入的密码请求时。 不要修改安装位置。

## 配置 VPN 客户端

若要连接到虚拟网络，您还需要配置 VPN 客户端。 客户端请求允许连接的客户端证书和 VPN 客户端配置正确。

### 创建 VPN 客户端配置包

1. 在 Azure 的门户中，在虚拟的网络，**仪表板**页面导航到右下角的快速浏览菜单，单击与您要连接到虚拟网络的客户机的 VPN 包。
下面的客户端操作系统支持︰
 - Windows 7 （32 位和 64 位）
 - Windows Server 2008 R2 （仅限于 64 位）
 - Windows 8 （32 位和 64 位）
 - Windows 8.1 （32 位和 64 位）
 - Windows Server 2012 （仅限于 64 位）
 - Windows Server 2012 R2 （仅限于 64 位）

1. 选择对应于在其安装客户端操作系统的下载包︰
 - 对于 32 位客户端，选择**32 位客户端 VPN 包下载**。
 - 对于 64 位客户端，选择**64 位客户端 VPN 包下载**。
1. 它将需要几分钟来创建客户端包。 完成包后，您将能够下载的文件。 您下载*.exe*文件可以安全地存储在本地计算机上。
1. 生成并下载从 Azure 门户的 VPN 客户端程序包后，您可以想要连接到虚拟网络的客户端计算机上安装客户机软件包。 如果您计划安装到多台客户端计算机的 VPN 客户机软件包，请确保它们还具有安装客户端证书。 VPN 客户机软件包包含配置 Windows 中内置的 VPN 客户端软件的配置信息。 包不安装额外的软件。

### 在客户端上安装 VPN 配置包和启动连接

1. 将配置文件复制到您想要连接到虚拟网络，然后双击.exe 文件的计算机的本地。 一旦安装程序包后，您可以启动 VPN 连接。
注意到由 Microsoft 没有签名的配置包。 您可能要签名包使用贵组织的签名服务，或使用[SignTool](https://msdn.microsoft.com/library/windows/desktop/aa387764(v=vs.85).aspx)自己签名。 它是确定签名的情况下使用该程序包。 但是，如果程序包未签名，安装包时，将显示警告。
2. 在客户端计算机上，导航到 VPN 的连接，定位您刚创建的 VPN 连接。 它将被命名为相同的虚拟网络名称。 单击**连接**。
3. 弹出消息将显示用于创建网关终结点的自签名的证书。 单击**继续**以使用提升的特权。
4. **连接**状态页面上单击，以启动该连接**连接**。
5. 如果您看到一个屏幕，**选择证书**，验证显示该客户端证书就是要用来连接。 如果不是这样，使用下拉箭头选择正确的证书，然后单击**确定**。
6. 您现在连接到虚拟网络，并具有完全访问权限的任何服务和虚拟网络中托管的虚拟机。

### 验证 VPN 连接

1. 若要验证 VPN 连接处于活动状态，请打开提升的命令提示符下，运行*ipconfig/所有*。
2. 查看结果。 请注意，您接收的 IP 地址是您 VNet 创建时所指定的点到站点的连接地址范围内的地址之一。 结果应类似于下面的内容︰

示例：



    PPP adapter VNetEast:
        Connection-specific DNS Suffix .:
        Description.....................: VNetEast
        Physical Address................:
        DHCP Enabled....................: No
        Autoconfiguration Enabled.......: Yes
        IPv4 Address....................: 192.168.130.2(Preferred)
        Subnet Mask.....................: 255.255.255.255
        Default Gateway.................:
        NetBIOS over Tcpip..............: Enabled



## 下一步行动


您可以了解有关虚拟网络跨本地连接在这篇文章︰[关于虚拟网络安全跨内部连接](vpn-gateway-cross-premises-options.md)。

如果您想要配置的站点到站点 VPN 连接，请参阅[配置站点到站点 VPN 网关连接使用的虚拟网络](vpn-gateway-site-to-site-create.md)。

可以将虚拟机添加到虚拟网络。 了解[如何创建一个自定义的虚拟机](../virtual-machines/virtual-machines-create-custom.md)。
