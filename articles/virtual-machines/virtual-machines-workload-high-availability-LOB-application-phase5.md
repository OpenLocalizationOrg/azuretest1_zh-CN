---
ms.openlocfilehash: 095b266f89e05be7172188968e40164fa829aee9
ms.sourcegitcommit: bab1265d669c3e6871daa7cb8a5640a47104947a
translationtype: MT
---
<properties 
    pageTitle="业务线应用程序阶段 5 |Microsoft Azure" 
    description="创建可用性组并向其中添加应用程序数据库，业务线应用程序在 Azure 中的阶段 5 中。" 
    documentationCenter=""
    services="virtual-machines" 
    authors="JoeDavies-MSFT" 
    manager="timlt" 
    editor=""
    tags="azure-resource-manager"/>

<tags 
    ms.service="virtual-machines" 
    ms.workload="infrastructure-services" 
    ms.tgt_pltfrm="na" 
    ms.devlang="na" 
    ms.topic="article" 
    ms.date="08/11/2015" 
    ms.author="josephd"/>

# 行的业务应用程序工作负荷阶段 5︰ 创建可用性组并添加应用程序数据库

在此部署在 Azure 的基础结构服务的业务应用程序的高可用性线条的最后阶段中，您创建新的 SQL Server AlwaysOn 可用性组并添加该应用程序的数据库。

请参阅[部署高可用性线条在 Azure 中的业务应用程序的](virtual-machines-workload-high-availability-LOB-application-overview.md)所有阶段。

## 创建可用性组并添加数据库

每个数据库的业务线应用程序︰

1.  采用主 SQL Server 虚拟机的完整备份和事务日志备份的数据库。
2.  还原完整和日志备份 SQL Server 虚拟机上的备份。

一旦数据库已同时备份和还原，它们可以被添加到可用性组。 SQL Server 仅允许已 （至少一次），备份和还原到另一台计算机，可在组中的数据库。

### 共享备份文件夹

若要启用备份和恢复，备份 (.bak) 文件必须可从辅助数据库服务器访问。 请执行以下步骤︰

1.  **[域] \sqladmin**登录主数据库服务器。 
2.  导航到 F:\ 磁盘。 
3.  用鼠标右键单击**备份**文件夹单击**共享对象**，单击**特定人**。
4.  在**文件共享**对话框中，键入**[域] \sqlservice**，，然后单击**添加**。
5.  请单击**权限级别**列**sqlservice**帐户名，然后单击**读/写**。 
6.  单击**共享**，然后单击**完成**。

在辅助数据库服务器，除了向 sqlservice 帐户在步骤 5 中的 F:\Backup 文件夹的**读取**权限授予执行上述过程。

### 备份和还原数据库

需要添加到可用性组的每个数据库都必须重复以下过程。

使用下列步骤来备份数据库。

1.  在主数据库服务器开始屏幕中，键入**SQL Studio**，，然后单击**SQL Server 管理 Studio**。
2.  单击**连接**。
3.  在左窗格中，展开**数据库**节点。
4.  用鼠标右键单击要备份，指向**任务**，然后单击**备份**的数据库。
5.  在**目标**部分中，单击**删除**删除备份文件的默认文件路径。
6.  单击**添加**。 在**文件名**中，键入**\\[计算机名] \backup\[数据库名称].bak**，其中**计算机名**是主 SQL **server 计算机**名称和**数据库名称**为数据库的名称。 单击**确定**，然后成功备份有关的消息后，再次单击**确定**。
7.  在左窗格中，用鼠标右键单击**[数据库]**，指向**任务**，然后单击**备份**。
8.  在**备份类型**选择**事务日志**，然后单击**确定**两次。
9.  使此远程桌面会话保持打开状态。

使用下列步骤还原数据库。

1.  [域名] \sp_farm_db 登录辅助数据库服务器。
2.  从开始屏幕中，键入**SQL Studio**，，然后单击**SQL Server 管理 Studio**。
3.  单击**连接**。
4.  在左窗格中，用鼠标右键单击**数据库**，然后单击**还原数据库**。
5.  在**源**部分中，选择**设备**，然后单击省略号 （...） 按钮
6.  在**选择备份设备**，请单击**添加**。
7.  在**备份文件的位置**，键入**\\[计算机名] \backup**，按**enter 键**，选择**[数据库].bak**，然后再单击**确定**两次。 您现在应该看到完整备份，在**要还原的备份集**部分中的日志备份。
8.  在**选择页**中，单击**选项**。 **还原选项**部分中，在**恢复状态**中，选择**还原与不恢复**，，然后单击**确定**。 
9.  单击**确定**时出现提示。

### 创建一个可用性组

至少一个数据库准备好 （使用备份和恢复方法） 后，您可以创建可用性组。

1.  返回到主数据库服务器远程桌面会话。
2.  在**SQL Server 管理 Studio**，在左窗格中，用鼠标右键单击**AlwaysOn 高可用性**，，然后单击**新建可用性组向导**。
3.  在**简介**页上，单击**下一步**。 
4.  在**指定的可用性组名称**页中，**可用性组名称**中键入的可用性组名称 (示例︰ AG1)，然后单击**下一步**。
5.  在**选择数据库**页上选择的数据库应用程序进行备份，然后单击**下一步**。 由于预期主要副本中已经至少一个完整备份，这些数据库满足可用性组的先决条件。
6.  在**指定的副本**页上，单击**添加副本**。
7.  在**连接到服务器**上，键入的辅助数据库服务器中，名称，然后单击**连接**。 
8.  在**指定副本**页中，辅助数据库服务器列入**可用性复制副本**。 对于这两个实例中，设置下列选项值︰ 

初始的角色 | 选项 | 值 
--- | --- | ---
主要 | 自动故障切换 （最多 2) | 选择
第二 | 自动故障切换 （最多 2) | 选择
主要 | 同步 （最多 3) 提交 | 选择
第二 | 同步 （最多 3) 提交 | 选择
主要 | 读第二 | 是
第二 | 读第二 | 是
        
9.  单击**下一步**。
10. 在**选择初始数据同步**页面上，选择**只参加**，，然后单击**下一步**。 通过在主服务器上，执行完整和事务备份并还原该备份手动执行数据同步。 相反，可以选择**完全**让新可用性组向导为您进行数据同步。 但是，同步不建议为在一些企业中找到的大型数据库。
11. 在**验证**页上，单击**下一步**。 可用性组侦听器配置不在于缺少的侦听器配置的警告。 
12. 在**摘要**页上，单击**完成**。 完成该向导后，检查**结果**页后，可以验证可用性组创建成功。 如果是这样，单击**关闭**以退出向导。 
13. 从开始屏幕中，键入**故障转移**，，然后单击**故障转移群集管理器**。 在左窗格中，打开您群集的名称，然后单击**角色**。 新角色的可用性组名称都不存在。

为您的应用程序数据库，您已成功配置 SQL Server AlwaysOn 可用性组。

![](./media/virtual-machines-workload-high-availability-LOB-application-phase5/workload-lobapp-phase4.png)

现在您可以开始部署到您的 intranet 用户此新应用程序。

## 配置的侦听器 AlwaysOn 可用性组

AlwaysOn 可用性组，您可以选择创建侦听器配置。 有关的步骤，请参阅[教程︰ 侦听器配置为 AlwaysOn 可用性组](https://msdn.microsoft.com/library/dn425027.aspx)。 这些说明逐步指导您完成创建只有一个侦听器 （推荐），并使用内部负载平衡实例的静态 IP 地址。

侦听器配置后，您需要配置的所有 web 服务器虚拟机使用监听器，而不是群集中的第一个 SQL 服务器的名称。 而不是使用新的 DNS 名称和记录映射到内部负载平衡实例的虚拟 IP 地址，配置 web 服务器虚拟机使用 SQL 别名。 有关详细步骤，请参阅[SharePoint 的 SQL 别名](http://blogs.msdn.com/b/priyo/archive/2013/09/13/sql-alias-for-sharepoint.aspx)。

## 其他资源

[部署在 Azure 中的业务应用程序的高可用性线条](virtual-machines-workload-high-availability-LOB-application-overview.md)

[行的业务应用程序的体系结构蓝图](http://msdn.microsoft.com/dn630664)

[设置基于 web 的 LOB 应用程序中用于测试的混合云](../virtual-network/virtual-networks-setup-lobapp-hybrid-cloud-testing.md)

[Azure 的基础结构服务实施指南](virtual-machines-infrastructure-services-implementation-guidelines.md)

[Azure 的基础结构服务工作负荷︰ SharePoint Server 2013 场](virtual-machines-workload-intranet-sharepoint-farm.md)
