---
ms.openlocfilehash: e80625a8bc02b89e8f13e791ece899b667d8160e
ms.sourcegitcommit: bab1265d669c3e6871daa7cb8a5640a47104947a
translationtype: MT
---
<properties
    pageTitle="如何为 Azure 远程应用程序创建自定义模板图像"
    description="了解如何为 Azure 远程应用程序创建了自定义模板映像。 与混合或云集合，您可以使用此模板。"
    services="remoteapp"
    documentationCenter=""
    authors="lizap"
    manager="mbaldwin"
    editor=""/>

<tags
    ms.service="remoteapp"
    ms.workload="compute"
    ms.tgt_pltfrm="na"
    ms.devlang="na"
    ms.topic="article"
    ms.date="08/12/2015" 
    ms.author="elizapo"/>

# 如何为 Azure 远程应用程序创建自定义模板图像
Azure 的远程应用程序使用 Windows Server 2012 R2 模板图像来承载您想要与您的用户共享的所有程序。 若要创建自定义的远程应用程序模板图像，可以与现有的映像启动或新建一个。 可以使用 Azure 远程应用程序上载的图像的要求是︰


- 图像大小应为 MBs 的倍数。 如果您试图上载不是完全相同的多个图像，传将失败。
- 图像大小必须是 127 GB 或更小。
- 它必须是一个 VHD 文件 （VHDX 文件 [Hyper-V 虚拟硬盘] 当前不支持）。
- VHD 不得第 2 代虚拟机。
- VHD 可以固定大小或动态扩展。 建议使用动态扩展 VHD，因为花费更少的时间要比大小固定 VHD 文件上载到 Azure。
- 必须使用主启动记录 (MBR) 分区样式初始化该磁盘。 GUID 分区表 (GPT) 分区形式不受支持。
- VHD 必须包含 Windows Server 2012 R2 的单个安装。 它可以包含多个卷，但只有一个包含 Windows 安装。
- 必须安装远程桌面会话主机 (RDSH) 角色和桌面体验功能。
- 远程桌面连接代理角色必须*不*被安装。
- 加密文件系统 (EFS)，则必须禁用它。
- 图像必须使用的参数的 SYSPREPed **/oobe / 一般化 /shutdown** （不要使用**/mode:vm**参数）。
- 不支持上载您的快照链从 VHD。

> [AZURE.TIP] 您知道您现在可以从 Azure VM 创建图像吗？ 真实的故事，而且它可以减少需要一段时间它采用将图像导入。 检查步骤[此处](remoteapp-image-on-azurevm.md)。

**在开始之前**

您需要创建服务之前执行以下操作︰

- 远程应用程序[注册](http://azure.microsoft.com/services/remoteapp/)。
- 在活动目录中才能为远程应用程序服务帐户使用创建的用户帐户。 限制此帐户的权限，以便只可以向域中加入的计算机。 有关更多信息，请参见[配置 Azure Active Directory 的远程应用程序](remoteapp-ad.md)。
- 收集有关您的内部网络信息︰ IP 地址信息以及 VPN 设备的详细信息。
- [Azure PowerShell](../install-configure-powershell.md)模块安装。
- 收集有关您想要授予访问权限的用户的信息。 这可以是 Microsoft 帐户信息或 Active Directory 工作的用户的帐户信息。



## 创建模板映像 ##

这些是要从头开始创建新的模板图像的大致步骤︰

1.  查找 Windows Server 2012 R2 更新 DVD 光盘或 ISO 映像。
2.  创建一个 VHD 文件。
4.  安装 Windows Server 2012 R2。
5.  安装远程桌面会话主机 (RDSH) 角色和桌面体验功能。
6.  安装您的应用程序所需的其他功能。
7.  安装和配置您的应用程序。
8.  执行所需的应用程序的所有其他 Windows 配置。
9.  禁用加密文件系统 (EFS)。
10. **要求︰**转到 Windows 更新，并安装所有重要更新。
9.  SYSPREP 映像。

创建新的图像的详细的步骤如下︰

1.  查找 Windows Server 2012 R2 更新 DVD 光盘或 ISO 映像。
2.  通过使用磁盘管理创建一个 VHD 文件。
    1.  启动磁盘管理 (diskmgmt.msc)。
    2.  创建一个动态扩展 VHD 的 40 GB 或更大。 （估计为 Windows，您的应用程序和自定义项所需的空间量。 用 RDSH 角色和安装桌面体验功能的 Windows 服务器将需要大约 10 GB 的空间）。
        1.  单击**操作 > 创建 VHD**。
        2.  指定的位置、 大小和 VHD 格式。 选择**动态扩展**，然后再单击**确定**。

            这将运行几秒钟。 VHD 创建完成后，您应该看到新的磁盘，而无需任何驱动器号和磁盘管理控制台中的"未初始化"状态。

        - 磁盘 （不是未分配的空间），用鼠标右键单击，然后单击**初始化磁盘**。 作为分区样式，选择**MBR** （主引导记录），然后单击**确定**。
        - 创建一个新卷︰ 用鼠标右键单击未分配的空间，然后单击**新建简单卷**。 您可以接受默认值在向导，但确保指派驱动器号以避免潜在的问题，当您上载的模板图像。
        - 用鼠标右键单击磁盘，然后单击**分离 VHD**。





1. 安装 Windows Server 2012 R2:
    1. 创建新的虚拟机。 在 Hyper-V 管理器或客户端 Hyper-V 使用新建虚拟机向导。
        1. 在指定生成页面上，选择**第 1 代**。
        2. 在连接虚拟硬盘页上，选择**使用现有虚拟硬盘**并浏览到您在上一步中创建的 VHD。
        2. 在安装选项页上选择**安装 CD/DVD_ROM 启动的操作系统**，然后选择 Windows Server 2012 R2 安装媒体的位置。
        3. 不必安装 Windows 和应用程序向导中选择其他选项。 完成该向导。
    2.  在向导完成后，编辑该虚拟机的设置和进行安装 Windows 和程序，如虚拟处理器的数量所需的任何其他更改，然后单击**确定**。
    4.  连接到虚拟机并安装 Windows Server 2012 R2。
1. 安装远程桌面会话主机 (RDSH) 角色和桌面体验功能︰
    1. 启动服务器管理器。
    2. 在欢迎使用屏幕或**管理**菜单上，单击**添加角色和功能**。
    3. 在开始之前页上，单击**下一步**。
    4. 选择**基于角色或功能的安装**，，然后单击**下一步**。
    5. 从列表中，选择本地计算机，然后单击**下一步**。
    6. 选择**远程桌面服务**，然后单击**下一步**。
    7. 展开**用户界面和基础结构**并选择**桌面体验**。
    8. 单击**添加功能**，然后单击**下一步**。
    9. 在远程桌面服务页上，单击**下一步**。
    10. 单击**远程桌面会话主机**。
    11. 单击**添加功能**，然后单击**下一步**。
    12. 在确认安装选项页中，选择**需要时自动重新启动目标服务器**，然后重启警告上单击**是**。
    13. 单击**安装**。 计算机将重新启动。
1.  安装所需的应用程序，例如.NET Framework 3.5 的其他功能。 要安装这些功能，请运行添加角色和功能向导。
7.  安装和配置的程序和应用程序要发布到远程应用程序。

    **重要︰**


    - 在安装应用程序以确保图像上载到远程应用程序之前，发现任何与应用程序兼容性问题之前安装 RDSH 角色。
    - 请确保您的应用程序出现在**「 开始 」**菜单。 此外，还要确保您在**开始**菜单中看到的图标希望用户看到。 如果不是，对其进行更改。 (不能*已*添加到起始应用程序菜单中，但它容易得多远程应用程序在发布应用程序。 否则，您需要为应用程序提供的安装路径，当您发布应用程序时。）

8.  执行所需的应用程序的所有其他 Windows 配置。
9.  禁用加密文件系统 (EFS)。 在提升的命令窗口中运行以下命令︰

        Fsutil behavior set disableencryption 1

    或者，您可以设置或在注册表中添加以下 DWORD 值︰

        HKLM\System\CurrentControlSet\Control\FileSystem\NtfsDisableEncryption = 1
9.  如果您正在构建内部 Azure 的虚拟机映像，则重命名**\%windir%\Panther\Unattend.xml**文件，这将阻止使用以后工作的上载脚本。 以便在需要恢复您的部署的情况下，仍会有该文件，请将此文件的名称更改为 Unattend.old。
10. 转到 Windows 更新，并安装所有重要更新。 您可能需要运行多次获取所有更新的 Windows 更新。 （有时您安装更新，并需要更新，该更新本身）。
10. SYSPREP 映像。 在提升的命令提示符处，运行以下命令︰

    **C:\Windows\System32\sysprep\sysprep.exe / /oobe /shutdown 一般化**

    **注意︰**即使这是虚拟机，请使用 SYSPREP 命令**/mode:vm**开关。


## 下一步行动 ##
现在，您已经自定义模板图像，您需要将该图像上传到远程应用程序集合。 使用以下文章中的信息来创建您的集合︰


- [如何创建远程应用程序的混合集合](remoteapp-create-hybrid-deployment.md)
- [如何创建远程应用程序的云集合](remoteapp-create-cloud-deployment.md)
 